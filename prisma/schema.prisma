generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

model Location {
  id           String           @id @default(cuid())
  name         String
  description  String?
  address      String
  rooms        Room[]
  facilitators Facilitator[]    @relation("FacilitatorLocations")
  events       ScheduledEvent[]
  terms        Term[]
  enrollments  Enrollment[]
  closures     Closure[]
}

model Facilitator {
  id                String           @id @default(cuid())
  firstname         String
  lastname          String
  email             String
  phone             String
  bio               String?
  address           String?
  profilePictureUrl String?
  color             String
  availability      Json
  notes             String?
  metadata          Json?
  isBookable        Boolean
  isBioDisplayed    Boolean
  locations         Location[]       @relation("FacilitatorLocations")
  tags              Tag[]            @relation("FacilitatorTags")
  events            ScheduledEvent[] @relation("EventFacilitators")
  services          Service[]        @relation("FacilitatorServices")
  enrollments       Enrollment[]
}

model Room {
  id           String           @id @default(cuid())
  name         String           @unique
  color        String
  locationId   String
  availability Json
  notes        String?
  metadata     Json?
  location     Location         @relation(fields: [locationId], references: [id])
  events       ScheduledEvent[]
  enrollments  Enrollment[]
}

model Client {
  id        String           @id @default(cuid())
  firstname String
  lastname  String
  email     String
  phone     String
  birthdate DateTime
  address   String
  notes     String?
  metadata  Json?
  events    ScheduledEvent[] @relation("EventClients")
  enrollments Enrollment[]
}

model Tag {
  id           String           @id @default(cuid())
  label        String
  parentId     String?
  metadata     Json?
  facilitators Facilitator[]    @relation("FacilitatorTags")
  events       ScheduledEvent[] @relation("EventTags")
  services     Service[]        @relation("ServiceTags")
}

model Service {
  id                     String           @id @default(cuid())
  name                   String
  description            String
  defaultDurationMinutes Int
  defaultPrice           Float
  notes                  String?
  metadata               Json?
  serviceCategoryId      String
  serviceCategory        ServiceCategory  @relation(fields: [serviceCategoryId], references: [id])
  tags                   Tag[]            @relation("ServiceTags")
  events                 ScheduledEvent[]

  facilitators Facilitator[] @relation("FacilitatorServices")
  enrollments  Enrollment[]
}

model ServiceCategory {
  id             String           @id @default(cuid())
  name           String
  description    String
  isDisplayed    Boolean
  isBookable     Boolean
  services       Service[]
  ScheduledEvent ScheduledEvent[]
}

model ScheduledEvent {
  id            String    @id @default(cuid())
  startTime     DateTime
  endTime       DateTime
  recurrence    String?
  recurrenceEnd DateTime?
  color         String
  price         Float
  notes         String? 

  // Relations
  roomId            String
  locationId        String
  serviceId         String
  serviceCategoryId String

  room            Room            @relation(fields: [roomId], references: [id])
  location        Location        @relation(fields: [locationId], references: [id])
  service         Service         @relation(fields: [serviceId], references: [id])
  serviceCategory ServiceCategory @relation(fields: [serviceCategoryId], references: [id])

  facilitators Facilitator[] @relation("EventFacilitators")
  clients      Client[]      @relation("EventClients")
  tags         Tag[]         @relation("EventTags")

  enrollmentId String?
  enrollment   Enrollment? @relation(fields: [enrollmentId], references: [id])
}

model Term {
  id         String   @id @default(cuid())
  name       String
  startDate  DateTime
  endDate    DateTime

  locationId String?
  location   Location? @relation(fields: [locationId], references: [id])

  createdAt  DateTime @default(now())
  updatedAt  DateTime @updatedAt

  enrollments Enrollment[]
}

model Enrollment {
  id         String   @id @default(cuid())

  // what was bought
  serviceId  String
  service    Service  @relation(fields: [serviceId], references: [id])

  // who
  clientId   String
  client     Client   @relation(fields: [clientId], references: [id])

  // where / with whom (optional at v1 if you want)
  locationId String
  location   Location @relation(fields: [locationId], references: [id])

  facilitatorId String?
  facilitator   Facilitator? @relation(fields: [facilitatorId], references: [id])

  roomId String
  room   Room @relation(fields: [roomId], references: [id])

  // which trimester
  termId     String
  term       Term     @relation(fields: [termId], references: [id])

  // recurrence rule (weekly)
  weekday    Int      // 0..6
  startTime  String   // "17:00" (easy v1)
  durationMinutes Int

  // active window
  startDate  DateTime
  endDate    DateTime

  // billing snapshot
  priceCharged Float
  pricingStrategy String // "TERM_FIXED_PRORATED" etc.
  status      String     // "DRAFT"|"PAID"|"ACTIVE"|"CANCELED"

  createdAt  DateTime @default(now())
  updatedAt  DateTime @updatedAt

  events ScheduledEvent[]
}

model Closure {
  id         String   @id @default(cuid())
  name       String
  startDate  DateTime
  endDate    DateTime

  locationId String?
  location   Location? @relation(fields: [locationId], references: [id])

  createdAt  DateTime @default(now())
  updatedAt  DateTime @updatedAt
}
